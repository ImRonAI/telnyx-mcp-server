# Prometheus alert rules for Telnyx MCP Server
groups:
  - name: telnyx-mcp-server.rules
    rules:
      # Server availability alerts
      - alert: TelnyxMCPServerDown
        expr: up{job="telnyx-mcp-server"} == 0
        for: 1m
        labels:
          severity: critical
          service: telnyx-mcp-server
        annotations:
          summary: "Telnyx MCP Server is down"
          description: "The Telnyx MCP Server has been down for more than 1 minute."
          runbook_url: "https://wiki.company.com/runbooks/telnyx-mcp-server-down"

      - alert: TelnyxMCPServerHealthCheckFailing
        expr: up{job="telnyx-mcp-health"} == 0
        for: 30s
        labels:
          severity: warning
          service: telnyx-mcp-server
        annotations:
          summary: "Telnyx MCP Server health check failing"
          description: "The Telnyx MCP Server health endpoint is not responding."

      # Performance alerts
      - alert: TelnyxMCPHighResponseTime
        expr: http_request_duration_seconds{quantile="0.95"} > 5
        for: 2m
        labels:
          severity: warning
          service: telnyx-mcp-server
        annotations:
          summary: "Telnyx MCP Server high response time"
          description: "95th percentile response time is {{ $value }}s (threshold: 5s)"

      - alert: TelnyxMCPHighErrorRate
        expr: (rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])) * 100 > 10
        for: 2m
        labels:
          severity: critical
          service: telnyx-mcp-server
        annotations:
          summary: "Telnyx MCP Server high error rate"
          description: "Error rate is {{ $value }}% (threshold: 10%)"

      # Resource utilization alerts
      - alert: TelnyxMCPHighMemoryUsage
        expr: process_resident_memory_bytes / (1024 * 1024) > 512
        for: 5m
        labels:
          severity: warning
          service: telnyx-mcp-server
        annotations:
          summary: "Telnyx MCP Server high memory usage"
          description: "Memory usage is {{ $value }}MB (threshold: 512MB)"

      - alert: TelnyxMCPHighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: telnyx-mcp-server
        annotations:
          summary: "Telnyx MCP Server high CPU usage"
          description: "CPU usage is {{ $value }}% (threshold: 80%)"

      # Connection and capacity alerts
      - alert: TelnyxMCPTooManyConnections
        expr: http_requests_active > 100
        for: 1m
        labels:
          severity: warning
          service: telnyx-mcp-server
        annotations:
          summary: "Telnyx MCP Server too many active connections"
          description: "Active connections: {{ $value }} (threshold: 100)"

      - alert: TelnyxMCPLowDiskSpace
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 5m
        labels:
          severity: critical
          service: telnyx-mcp-server
        annotations:
          summary: "Telnyx MCP Server low disk space"
          description: "Disk space usage is {{ $value }}% (threshold: 90%)"

      # External dependency alerts  
      - alert: TelnyxAPIUnreachable
        expr: probe_success{job="telnyx-api-probe"} == 0
        for: 2m
        labels:
          severity: critical
          service: telnyx-mcp-server
          dependency: telnyx-api
        annotations:
          summary: "Telnyx API is unreachable"
          description: "Cannot reach Telnyx API from MCP server"

  - name: telnyx-mcp-server-sla.rules
    rules:
      # SLA tracking
      - record: telnyx_mcp_server:availability_1h
        expr: avg_over_time(up{job="telnyx-mcp-server"}[1h])

      - record: telnyx_mcp_server:availability_24h
        expr: avg_over_time(up{job="telnyx-mcp-server"}[24h])

      - record: telnyx_mcp_server:error_rate_5m
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])

      - record: telnyx_mcp_server:response_time_95p_5m
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

      # SLA violation alerts
      - alert: TelnyxMCPSLAViolation
        expr: telnyx_mcp_server:availability_1h < 0.99
        for: 0m
        labels:
          severity: critical
          service: telnyx-mcp-server
          sla: availability
        annotations:
          summary: "Telnyx MCP Server SLA violation"
          description: "Availability in the last hour: {{ $value | humanizePercentage }} (SLA: 99%)"